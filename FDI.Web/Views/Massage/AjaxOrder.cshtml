@model FDI.Simple.OrderGetItem
@{
    Layout = "~/Views/Shared/_Ajax.cshtml";
    var date = DateTime.Now.AddMinutes(2);
}
<script src="/Content/Admin/js/numeral.min.js"></script>
<script>
    
    $(function () {
        var prizeMoney = 0;
        var objbed = JSON.parse($("#listbed").val());
        $("#listbed").val("");
        var a = true;
        callSelect2("#HoursStart", "80px");
        callSelect2("#MinuteStart", "80px");
        
        $('#Customer').autocomplete({
            serviceUrl: "/BookATable/AutoCustomer",
            minChars: 1,
            delimiter: /(;)\s*/,
            maxHeight: 400,
            onSelect: function (el) {
                $('#CustomerID').val(el.ID);
                $('#FullName').val(el.title);
                $('#Mobile').val(el.phone);
                $('#Address').val(el.code);
                $('#printKH').html(el.title);
                $('#Bonus').html(numeral(el.TotalPrice).format('0,0'));
                if (el.keword === el.value) {
                    prizeMoney = el.TotalPrice;
                } else prizeMoney = 0;
                $('#Customer').val("");
            }
        });

        $("#frm-Order").validate({
            rules: {
                FullName:
                {
                    required: true
                },
                ProductID:
                {
                    required: true
                }
            },
            messages: {
                FullName:
                {
                    required: "Trường này là bắt buộc."
                },
                ProductID:
                {
                    required: "Chọn gói dịch vụ."
                }
            },
            submitHandler: function () { //onSubmit
                btnDisabled("#btnSave");
                var d = $("#SetDate_").val();
                var h = $("#HoursStart").val();
                var m = $("#MinuteStart").val();
                var date = intGetTimeByDate(d, h, m);
                var datenow = intDateNow();
                if (datenow < date && a) {
                    a = false;
                    var price = $("#ProductID option:selected").attr("data-Price");
                    $("#totalPrice").html('<strong>Tổng</strong><strong>' + price + '</strong><strong>&nbsp;</strong><strong>' + price + '</strong>');
                    $('.maskPrice').each(function (i) {
                        $(this).val($(this).val().replace(/\,/g, ''));
                    });
                    $.post(urlPostAction + "?StartDate=" + date, $("#frm-Order").serialize(), function (data) {
                        btnEnable("#btnSave");
                        if (data.Erros)
                            toastr["error"](data.Message);
                        else {
                            createShowMessage("Thông báo", data.Message); // Tạo thông báo khi click đóng thì chuyển đến url đích
                            printOrder();
                        }
                        a = true;
                    });
                } else if (!a) {
                    btnEnable("#btnSave");
                    createMessage("Thông báo", "Sever đang xử lý bạn hãy chờ!", ''); // Tạo thông báo khi click đóng thì chuyển đến url đích
                } else {
                    btnEnable("#btnSave");
                    createMessage("Thông báo", "Thời gian bắt đầu nhỏ hơn thời gián hiện tại", ''); // Tạo thông báo khi click đóng thì chuyển đến url đích
                }
            }
        });
        $("#ProductID").change(function () {
            $("#Value").val($("#ProductID option:selected").attr("data-Value"));
            $("#Price").html($("#ProductID option:selected").attr("data-Price"));
        });

        $("body").on("keyup", "#frm-Order #PrizeMoney", function () {
            var pr = $("#PrizeMoney").val() !== "" ? parseFloat($("#PrizeMoney").val().replace(/[,]+/g, '')) : 0;
            var price2 = $("#Price").html() !== "" ? parseFloat($("#Price").html().replace(/[,]+/g, '')) : 0;
            if (pr > prizeMoney) {
                ErrorMessage("Bạn chưa quẹt thẻ hoặc vượt quá tiền tích lũy.");
                $("#PrizeMoney").val(numeral(prizeMoney).format('0,0'));
            }
            if (pr > price2) {
                ErrorMessage("Vượt quá tiền hóa đơn.");
                $("#PrizeMoney").val(numeral(price2).format('0,0'));
            }
        });

        function printOrder() {
            var price = $("#ProductID option:selected").attr("data-Price");
            var priceBonus = parseFloat($("#PrizeMoney").val());
            var priceRoot = parseFloat($("#Bonus").text().replace(/[,]+/g, ''));
            var note = $("#Note").val();
            var d = $("#SetDate_").val();
            var h = $("#HoursStart").val();
            var m = $("#MinuteStart").val();
            var startDate = intGetTimeByDate(d, h, m);
            var pm = parseInt($("#ProductID option:selected").attr("data-Value")) * 60;
            var bonus = priceRoot - priceBonus;
            var endDate = startDate + pm;
            $("#listboxprint").html("<div class='pr-item'><b>" + $("#ProductID option:selected").text() + "</b><div class='pr-property'><span>&nbsp;</span><span>" + price + "</span><span>0%</span><span>" + $("#ProductID option:selected").attr("data-Price") + "</span></div></div>");
            $("#prinPrice").html(price);
            $("#printSale").html(price);
            $("#printPriceCusN").html(price);
            $("#printKH").html($("#FullName").val());
            $("#printSale").html(price);
            $("#printPrizeMoney").html(numeral(priceBonus).format('0,0'));
            $("#printMoney").html(numeral(bonus).format('0,0'));
            $("#printProduct").html(objbed.RoomName);
            $("#printPacket").html(objbed.PacketName);
            showddMMyyyyhhmmss(startDate, "#printHIn");
            showddMMyyyyhhmmss(endDate, "#printHOut");
            $("#PriceVND").html(DocTienBangChu(price));
            $("#printEmp").html(objbed.DN_User_BedDesk.FullName);
            $("#lblNote").html(note);
            $('#BoxPrint').show();
            jQuery.print('#BoxPrint');
            $('#BoxPrint').hide();
            $(".modal").modal('hide');
        }
    })
</script>
<form id="frm-Order">
    <div class="modal-body">
        <input type="hidden" name="do" id="do" value="Edit" />
        <input type="hidden" name="ID" id="ID" value="@Model.ID" />
        <input type="hidden" name="itemId" id="itemId" value="@Model.BedDeskID" />
        <input type="hidden" name="IsEarly" id="IsEarly" value="@Model.IsEarly.ToString()" />
        <div class="portlet box green">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-database"></i>Thông tin khách hàng
                </div>
            </div>
            <div class="portlet-body form">
                <div class="form-body">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-md-2 control-label">Khách hàng</label>
                            <div class="col-md-10">
                                <input class="form-control" id="Customer" name="Customer" value="">
                                <input type="hidden" id="CustomerID" name="CustomerID" value="">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">Họ Tên</label>
                            <div class="col-md-10">
                                <input class="form-control" id="CustomerName" name="CustomerName" value="@Model.CustomerName">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">Địa chỉ</label>
                            <div class="col-md-10">
                                <input class="form-control" id="Address" name="Address" value="@Model.Address">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">Số điện thoại</label>
                            <div class="col-md-10">
                                <input class="form-control" id="Mobile" name="Mobile" value="@Model.Mobile">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">Điểm tích lũy</label>
                            <div class="col-md-10">
                                <p class="form-control-static" id="Bonus"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="portlet box green">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-database"></i>Thanh toán
                </div>
            </div>
            <div class="portlet-body form">
                <div class="form-body">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-md-2 control-label">Gói dịch vụ</label>
                            <div class="col-md-10">
                                <select class="form-control" id="ProductID" name="ProductID">
                                    @*<option value="" data-value="0">-- Chọn gói --</option>*@
                                    @foreach (var item in Model.ListItem)
                                    {
                                        <option value="@item.ID" @(Model.Value == item.Value ? "selected" : string.Empty) data-Value="@item.Value" data-Price="@string.Format("{0:0,0}", item.PriceNew)">@item.Name</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">Thời gian</label>
                            <div class="col-md-5">
                                <input class="form-control date-picker" id="SetDate_" name="SetDate_" value="@date.ToString("dd/MM/yyyy"))" data-date-format="dd/mm/yyyy">
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">Giờ bắt đầu</label>
                                    <div class="col-sm-8">
                                        <select name="HoursStart" id="HoursStart" class="select2">
                                            @for (int i = 0; i <= 23; i++)
                                            {
                                                <option value="@i" @(date.Hour == i ? "selected" : string.Empty)>@i</option>
                                            }
                                        </select>

                                        <select name="MinuteStart" id="MinuteStart" class="select2">
                                            @for (int i = 0; i <= 59; i++)
                                            {
                                                <option value="@i" @(date.Minute == i ? "selected" : string.Empty)>@i</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-2 control-label">Ghi chú</label>
                            <div class="col-md-10">
                                <textarea class="form-control" id="Note" name="Note" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Sử dụng tích lũy:</label>
                            <div class="col-sm-10">
                                <input type="text" id="PrizeMoney" name="PrizeMoney" class="form-control maskPrice" value="0" />
                            </div>
                        </div>
                        <div class="form-group">
                                    <label class="col-sm-2 control-label"><b>TỔNG TIỀN</b></label>
                                    <div class="col-sm-4">
                                        <p class="form-control-statics label label-danger" id="Price">@string.Format("{0:0,0}", Model.ListItem.Select(c => c.PriceNew).FirstOrDefault())</p>
                                    </div>
                                    <label class="col-sm-2 control-label"><b>THANH TOÁN</b></label>
                                    <div class="col-sm-4">
                                        <p class="form-control-statics label label-danger" id="Payment">@string.Format("{0:0,0}", Model.ListItem.Select(c => c.PriceNew).FirstOrDefault())</p>
                                    </div>
                            <input type="hidden" name="Value" id="Value" value="@Model.ListItem.Select(c => c.Value).FirstOrDefault()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

                            </div>
    <div class="modal-footer">
        <button id="btnPrint" type="button" class="btn btn-sm btn-primary">In</button>
        <button id="btnSave" type="submit" class="btn btn-sm btn-primary">In và Lưu lại</button>
        <button id="btnReset" type="reset" name="reset" class="btn btn-sm btn-info">Nhập lại</button>
        <button id="close" type="button" class="btn btn-sm btn-default" data-dismiss="modal">Đóng</button>
    </div>
</form>

@Html.Action("AjaxPrint")
@*<link href="~/Content/Admin/css/style_hoadon.css" rel="stylesheet" />
<script src="~/Content/Admin/js/jQuery.print.js"></script>
<div id="BoxPrint" style="display: none;">
    <div class="box-pr-payment">
        <div class="pr-header">
            <div class="pr-logo">
               
            </div>
            <div class="pr-address">
            </div>
        </div>
        <div class="pr-content">
            <div class="pr-title-code">
                <strong>HÓA ĐƠN PHỤC VỤ</strong>
                <i id="printMP">QLBP/29 @DateTime.Now.ToString("dd/MM/yyyy")</i>
            </div>
            <div class="pr-detail-employee">
                <ul>
                    <li><strong>Thu ngân:</strong><span id="printNV">@ViewBag.FullName</span></li>
                    <li><strong>Khách Hàng</strong><span id="printKH">Tạ Cao Tầng</span></li>
                    <li><strong>Vào</strong><span id="printHIn">12/04/2017 2:02:00 PM</span></li>
                    <li><strong>Ra</strong><span id="printHOut">12/04/2017 4:02:00 PM</span></li>
                    <li><strong>Phòng</strong><span id="printProduct"></span></li>
                    <li><strong>Gói</strong><span id="printPacket"></span></li>
                    <li><strong>Nhân viên:</strong><span id="printEmp">Nguyễn Thiên Hiệp</span></li>
                    <li><strong>Điểm tích lũy còn lại:</strong><span id="printMoney"></span></li>
                </ul>
            </div>
            <div class="pr-list-product">
                <div class="pr-head">
                    <strong>Sản phẩm</strong>
                    <strong>Nguyên giá</strong>
                    <strong>% &darr;</strong>
                    <strong>Giá bán</strong>
                </div>
                <div id="listboxprint">
                </div>
                <div class="pr-head" id="totalPrice">
                    
                </div>
            </div>
            <div class="pr-detail-pay">
                <ul>
                    <li><strong>Tổng tiền:</strong><span id="printSale">0</span></li>
                    <li><strong><b>Chiết khẩu:</b></strong><span><b id="printDiscount">0%</b></span></li>
                    <li><strong><b>Tích lũy dùng:</b></strong><span><b id="printPrizeMoney">0</b></span></li>
                    <li><strong>Tổng phải trả:</strong><span id="printPriceCusN">0</span></li>
                    <li><strong>Ghi chú:</strong><span id="lblNote"></span></li>
                </ul>
            </div>
        </div>
        <div class="pr-footer">
            <strong id="PriceVND"></strong>
        </div>
    </div>
</div>*@
