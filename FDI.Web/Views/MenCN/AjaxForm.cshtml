@using FDI.CORE
@model FDI.Simple.QLCN.MenCNItem
@{
    Layout = "~/Views/Shared/_Ajax.cshtml";
    var stt = 1;
    var lst = Model.LstNguyenlieuCnItems != null ? string.Join(",", Model.LstNguyenlieuCnItems.Select(c => c.IdNguyenlieu)) : "";
}
<script>
    $(document).ready(function () {
        callSelect2("#UnitID", "100%");
        $("#modalForm").validate({
            rules: {
                Name: {
                    required: true,
                },
                UnitID: {
                    required: true,
                }
            },
            messages: {
                Name:
                {
                    required: "Trường này bắt buộc nhập.",
                },
                UnitID:
                {
                    required: "Trường này bắt buộc nhập.",
                }
            },
            submitHandler: function () { //onSubmit
                $.post("/Utility/DeleteNguyenlieuCNItem?key=" + getCookie('CodeLogin'), function () {
                    $('#NguyenlieuCN .data').each(function () {
                        var ret = [];
                        $('.inputValue', this).each(function () {
                            var d = $(this).val() || $(this).text();
                            ret.push(d);
                        });
                        var item = {
                            IdNguyenlieu: ret[0],
                            Quantity: ret[1],
                            Key: getCookie('CodeLogin')
                        };
                        $.post("/Utility/AddNguyenlieuCNItem?json=" + JSON.stringify(item), function () { });
                    });
                    PostAction("#modalForm");
                });
               
            }
        });
        var lstP = JSON.parse("[@(lst)]");
        $('#autoProduct').autocomplete({
            serviceUrl: "/MenCN/AutoNguyenlieu",
            minChars: 1,
            delimiter: /(;)\s*/,
            maxHeight: 400,
            onSelect: function (el) {
                $('#autoProduct').val("");
                var index = lstP.indexOf(el.ID);
                if (index === -1) {
                    lstP.push(el.ID);
                    var txt = "<tr class='data'><td>stt</td><td>name</td><td align='center'><input type='hidden' class='inputValue' value='IdNguyenlieu'/><input type='number' step='0.001' class='form-control text-right inputValue quan' data-pid='IdNguyenlieu'  value='1'/></td><td class='text-right'><button class='btn btn-default pdelete' data-pid='IdNguyenlieu' ><i class='fa fa-trash-o' style='color: red;'></i></button></td></tr>";
                    txt = txt.replace("stt", lstP.length);
                    txt = txt.replace("name", el.value);
                    txt = txt.replace(/IdNguyenlieu/g, el.ID);
                    $("#NguyenlieuCN tbody").append(txt);
                }
            }
        });
        $("body").on("click", ".pdelete", function () {
            var pid = parseInt($(this).attr("data-pid"));
            var index = lstP.indexOf(pid);
            lstP.splice(index, 1);
            $(this).parent().parent().remove();
        });
    });
</script>
<form id="modalForm">
    <div class="modal-body">
        <input type="hidden" name="do" id="do" value="@ViewBag.Action" />
        <input type="hidden" name="ItemID" id="ItemID" value="@Model.ID" />
        <div class="portlet box green">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-database"></i>Thêm mới loại Men
                </div>
            </div>
            <div class="portlet-body form">
                <div class="form-body">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Tên Men</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" placeholder="..." name="Name" id="Name" value="@Model.Name" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Đơn vị</label>
                            <div class="col-sm-10">
                                <select name="UnitID" id="UnitID" class="form-control">
                                    <option value="">Chọn đơn vị</option>
                                    @foreach (var item in ViewBag.lstUnit)
                                    {       
                                        <option @(item.ID == Model.UnitID ? "selected" : "")  value="@item.ID">@item.Name</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="portlet box green">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-external-link-square"></i>Công thức
                </div>
            </div>
            <div class="portlet-body form">
                <div class="form-body">
                    <div class="form-horizontal" style="margin-bottom: 20px;">
                        <div class="input-group">
                            <span class="input-group-addon">
                                <i class="fa fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="autoProduct" placeholder="Nhập tên nguyên liệu" />
                        </div>
                    </div>
                    <table class="gridView table table-bordered table-striped" id="NguyenlieuCN">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên nguyên liệu</th>
                                <th class='text-center' style="width: 100px">Số lượng</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.LstNguyenlieuCnItems != null)
                            {
                                foreach (var item in Model.LstNguyenlieuCnItems)
                                {
                                    <tr class="data">
                                        <td>@(stt++)</td>
                                        <td>@item.Nguyenlieu</td>
                                        <td align="center">
                                            <input type="hidden" class="inputValue" value="@item.IdNguyenlieu">
                                            <input type="number" step="0.001" class="form-control text-right inputValue quan" data-pid="@item.IdNguyenlieu" value="@item.Quantity.Quantity("0:0.####")">
                                        </td>
                                        <td class="text-right">
                                            <button class="btn btn-default pdelete" data-pid="@item.IdNguyenlieu"><i class="fa fa-trash-o" style="color: red;"></i></button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button id="btnSave" type="submit" class="btn btn-sm btn-success">Cập nhật</button>
        <button id="close" type="button" data-dismiss="modal" class="btn btn-sm btn-default">Đóng</button>
    </div>
</form>
