@using FDI.CORE
@model FDI.Simple.OrderDetailItem
@{
    Layout = "~/Views/Shared/_Ajax.cshtml";
    var stt = 1;
}
<script src="~/Content/Admin/js/numeral.min.js"></script>
<script>
    $(function () {
        
        
        $("#frm-Product").validate({
            rules: {
                Name: { required: true },
                StartDate_: { required: true },
                EndDate_: { required: true },
                Quantity: { required: true }
            },
            messages: {
                Name: "Trường này là bắt buộc .",
                StartDate_: "Trường này là bắt buộc .",
                EndDate_: "Trường này là bắt buộc .",
                Quantity: "Trường này là bắt buộc ."
            },
            submitHandler: function () { //onSubmit
                $("#btnSave").prop('disabled', true);
                //$('.maskPrice').each(function (i) {
                //    $(this).val($(this).val().replace(/\,/g, ''));
                //});

                $.post("/Utility/DeleteCostProductUser?key=" + getCookie('CodeLogin'), function () {
                    $('#UserCost .data').each(function () {                        
                        var user = $(this).attr("data-guid");
                        var id = $(this).attr("data-id");
                        if (user != "") {
                            var item = {
                                SetupProductId: id,
                                UserId: user,
                                Key: getCookie('CodeLogin')
                            }
                            $.post("/Utility/AddCostProductUser?json=" + JSON.stringify(item), function () { });
                        }
                    });
                    $.post("/BiasProduce/Actions", $("#frm-Product").serialize(), function (data) {
                        $("#btnSave").prop('disabled', false);
                        if (data.Erros)
                            createMessage("Đã có lỗi xảy ra", data.Message); // Tạo thông báo lỗi
                        else {
                            $("#dialog-form").modal('hide'); //Đóng form thêm mới - sửa
                            createCloseMessage("Thông báo", data.Message, ""); // Tạo thông báo khi click đóng thì chuyển đến url đích
                        }
                    });
                });
            }
        });

        $(".useritem").autocomplete({
            serviceUrl: "/OrderFashionDetail/AutoUser",
            minChars: 1,
            delimiter: /(;)\s*/,
            maxHeight: 400,
            onSelect: function (el) {
                $(this).attr("data-guid", el.GuiID);
            }
        });
    });
    
</script>
<form id="frm-Product">
    <div class="modal-body">
        <input type="hidden" name="do" id="do" value="Add" />
        <input type="hidden" name="ItemID" id="ItemID" value="@Model.ID" />
        <input type="hidden" name="AgencyID" id="AgencyID" value="@ViewBag.AgencyID" />
        <div class="portlet box green">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-database"></i>Thiết lập lệnh sx
                </div>
            </div>
            <div class="portlet-body form">
                <div class="form-body">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Tên Lệnh SX</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" placeholder="..." name="Name" id="Name" value="" />
                            </div>
                            <label class="col-sm-2 control-label">Số lượng</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control quantity" name="Quantity" id="Quantity" value="@Model.Quantity" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Ngày bắt đầu</label>
                            <div class="col-sm-4">
                                <input type="date" class="form-control" name="StartDate_" id="StartDate_" value="@Model.StartDate.DecimalToString("dd/MM/yyyy")" />
                            </div>
                            <label class="col-sm-2 control-label">Ngày kết thúc</label>
                            <div class="col-sm-4">
                                <input type="date" class="form-control" name="EndDate_" id="EndDate_" value="@Model.EndDate.DecimalToString("dd/MM/yyyy")" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Sản phẩm</label>
                            <div class="col-sm-4">
                                <label class="control-label">@Model.ProductName</label>
                                <input type="hidden" name="ProductID" id="ProductID" value="@Model.ProductID" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="portlet box green">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-database"></i>Nhân công
                </div>
            </div>
            <div class="portlet-body form">
                <div class="form-body">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <div class="col-sm-8 col-md-offset-2">
                                <table class="gridView" style="width: 100%" id="UserCost">
                                    @if (Model.SetupProductionItems != null)
                                    {
                                        foreach (var item in Model.SetupProductionItems)
                                        {
                                            <tr>
                                                <td>@item.Name</td>
                                                <td>
                                                    <input class='form-control useritem data' data-id='@item.ID' data-guid='@item.ID' value="" />
                                                </td>                                                
                                            </tr>
                                        }
                                    }
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        @if (Model.LstRecipeItems.Any())
        {
            <div class="portlet box green">
                <div class="portlet-title">
                    <div class="caption">
                        <i class="fa fa-database"></i>Nguyên liệu sản xuất
                    </div>
                </div>
                <div class="portlet-body form">
                    <div class="form-body">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <table class="gridView" id="ProductDetail" style="width: 100%">
                                    <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>Tên Nguyên liệu</th>
                                            <th class='text-center'>Số lượng cần</th>
                                            <th class='text-center'>Số lượng trong kho</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.LstRecipeItems)
                                        {
                                            <tr class="data">
                                                <td>@(stt++)</td>
                                                <td>@item.ValueName</td>
                                                <td class='text-center'>@string.Format("{0:0.##}", item.Quantity)</td>
                                                <td class='text-center'>@string.Format("{0:0.##}", item.ValueQuantity)</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="modal-footer">
        <button id="btnSave" type="submit" class="btn btn-sm btn-success">Cập nhật</button>
        <button id="close" type="button" data-dismiss="modal" class="btn btn-sm btn-default">Đóng</button>
    </div>
</form>