@model FDI.Simple.ModelCityItem
@*<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>*@
@*<script src="//maps.google.com/maps/api/js?sensor=true" type="text/javascript"></script>*@
<link href="/Areas/Other/Content/css/Utilities.css" rel="stylesheet" />
@*<script src="~/Areas/Other/Content/Publishing/js/jquery.magnific.min.js"></script>*@
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>

@{
    var index = -1;
}
<div id="container">
    <div>
        <h1>Tìm điểm giao dịch</h1>
    </div>
    <div id="map-canvas"></div>
    <div id="markers"></div>
    <form id="formGoogleMap">
        <div class="box-filter">
            <div class="col-sm-2">
                <label>Tỉnh thành phố</label>
            </div>
            <div class="col-sm-4">
                <select id="GoogleMapCityID" name="GoogleMapCityID" class="form-control">
                    <option value="0">--- Chọn Thành Phố ---</option>
                    @foreach (var item in Model.ListItem)
                    {
                        <option value="@item.ID">@item.Name.Trim()</option>
                    }
                </select>
            </div>
            <div class="col-sm-2">
                <label>Quận huyện</label>
            </div>
            <div class="col-sm-4">
                <select id="DistrictID" name="DistrictID" class="form-control">
                    <option value="0">--- Chọn quận huyện ---</option>
                </select>
            </div>
        </div>
    </form>
    <div id="box-address">
        @foreach (var item in Model.ListGoogleMapItem.OrderByDescending(m => m.ID))
        {
            index = index + 1;
            <div class="row" style="margin-bottom: 10px;">
                <div class="col-sm-6">
                    <div class="col-sm-12">
                        <span><strong style=""><a class="ViewGooglemap" data-markerid="@index" data-content="@item.Address" data-longitude="@item.Longitude" data-latitude="@item.Latitude">@item.Name </a></strong></span>
                        <br />
                        <span>@item.Address</span>
                    </div>
                </div>
                <div class="col-sm-6">
                    <br />
                    <div class="col-sm-6">Tel: @item.Tel</div>
                    <div class="col-sm-6">Fax: @item.Fax</div>
                </div>
            </div>
        }
    </div>
</div>

<script type="text/javascript">
    google_map(0, 0);
    function google_map(cityId, districtId) {
        var markers = new Array();
        function initialize() {
            var locations = [];
            var mapOptions = {
                zoom: 12,
                mapTypeId: window.google.maps.MapTypeId.ROADMAP,
                center: new window.google.maps.LatLng(21.027821, 105.833873)
            };
            var map = new window.google.maps.Map(document.getElementById('map-canvas'), mapOptions);
            var image = new window.google.maps.MarkerImage('/Areas/Other/Content/images/abbank.png',
                new window.google.maps.Size(30, 30),
                new window.google.maps.Point(0, 0)
            );
            $.getJSON("/Other/Other/GetData?cityID=" + cityId + "&districtID=" + districtId, function (googleMaps) {
                
                $.each(googleMaps, function (key, value) {
                    locations.unshift([new window.google.maps.LatLng(value.latitude, value.longitude), value.infowindow]);
                });
                //var locations = [
                //    [new window.google.maps.LatLng(0, 0), 'Marker 1', 'Infowindow content for Marker 1'],
                //    [new window.google.maps.LatLng(0, 1), 'Marker 2', 'Infowindow content for Marker 2'],
                //    [new window.google.maps.LatLng(0, 2), 'Marker 3', 'Infowindow content for Marker 3'],
                //    [new window.google.maps.LatLng(1, 0), 'Marker 4', 'Infowindow content for Marker 4'],
                //    [new window.google.maps.LatLng(1, 1), 'Marker 5', 'Infowindow content for Marker 5'],
                //    [new window.google.maps.LatLng(1, 2), 'Marker 6', 'Infowindow content for Marker 6']
                //];

                
                var infowindow = new window.google.maps.InfoWindow();
                for (var i = 0; i < locations.length; i++) {
                    // Append a link to the markers DIV for each marker
                    //$('#markers').append('<a class="marker-link" data-markerid="' + i + '" href="#">a'+i+ '</a> ');
                    var marker = new window.google.maps.Marker({
                        position: locations[i][0],
                        map: map,
                        icon: image,
                        title: locations[i][1],
                    });
                    // Register a click event listener on the marker to display the corresponding infowindow content
                    window.google.maps.event.addListener(marker, 'click', (function (marker, i) {
                        return function () {
                            infowindow.setContent(locations[i][1]);
                            infowindow.open(map, marker);
                        };
                    })(marker, i));
                    // Add marker to markers array
                    markers.push(marker);
                }
                ;
            });
            // Trigger a click event on each marker when the corresponding marker link is clicked
            $('body').on("click", ".ViewGooglemap", function () {
                window.google.maps.event.trigger(markers[$(this).data('markerid')], 'click');
                $('html, body').animate({ scrollTop: $('#map-canvas').position().top }, 'slow');
            });
        }
        initialize();
    }


    $('body').on("change", "#GoogleMapCityID", function () {
        if (this.value != "0") {
            google_map(this.value, 0);
            $.get("/Other/Other/GetListGoogleMapByCityId?cityID=" + this.value, function (data) {
                $('#box-address').html(data);
            });
            $.post("/Other/Other/GetDistrictItemByCityId?cityID=" + this.value, function (lstDistrict) {
                $("#DistrictID").html("");
                $("#DistrictID").append('<option value="0">--- Chọn quận huyện ---</option>');
                $.each(lstDistrict, function (i, val) {
                    $("#DistrictID").append("<option value='" + val.ID + "'>" + val.Name.trim() + "</option>");
                });
            });
        } else {
            google_map(0, 0);
            $("#DistrictID").html("");
            $("#DistrictID").append('<option value="0">--- Chọn quận huyện ---</option>');
        }
    });

    $('body').on("change", "#DistrictID", function () {
        if (this.value != 0) {
            google_map($("#GoogleMapCityID").val(), this.value);
            $.get("/Other/Other/GetListGoogleMapByDistrictID?districtID=" + this.value, function (data) {
                $('#box-address').html(data);
            });
        } else {
            $.get("/Other/Other/GetListGoogleMapByCityId?cityID=" + $("#GoogleMapCityID").val(), function (data) {
                $('#box-address').html(data);
                google_map($("#GoogleMapCityID").val(), 0);
            });
        }
    });
    //$("#box-address a").click(function () {
    //    alert('a');
    //});

    //$('body').on("click", ".ViewGooglemap", function () {
        //debugger;
        //var mapOptions = {
        //    zoom: 12,
        //    mapTypeId: window.google.maps.MapTypeId.ROADMAP,
        //    center: new window.google.maps.LatLng(21.027821, 105.833873)
        //};
        //var map = new window.google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        //var latitude = $(this).data("latitude");
        //var longitude = $(this).data("longitude");
        //var content = $(this).data("content");
        //var marker = new window.google.maps.Marker({
        //    position: new window.google.maps.LatLng(latitude, longitude),
        //    map: map,
        //    title: content,
        //});
        //window.google.maps.event.trigger(marker, 'click');

    //    $('html, body').animate({ scrollTop: $('#map-canvas').position().top }, 'slow');
    //});
</script>
